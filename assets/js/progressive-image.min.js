// progressive-image.js

var pItem, timer

if (window.addEventListener && window.requestAnimationFrame && document.getElementsByClassName) window.addEventListener('load', function() {
  // start
  pItem = document.getElementsByClassName('progressive replace');

  window.addEventListener('scroll', scroller, false);
  window.addEventListener('resize', scroller, false);
  inView();

}, false);


function restartProgressiveLoading(){
  var pItem = document.getElementsByClassName('progressive replace');
  inView();


}


// throttled scroll/resize
function scroller(e) {

  timer = timer || setTimeout(function() {
    timer = null;
    requestAnimationFrame(inView);
  }, 300);

}


// image in view?
function inView() {

  var wT = window.pageYOffset, wB = wT + window.innerHeight, cRect, pT, pB, p = 0;
  while (p < pItem.length) {
    cRect = pItem[p].getBoundingClientRect();
    pT = wT + cRect.top;
    pB = pT + cRect.height;

    // console.log(wT + ", " + pB + ", " + wB + ", " + pT);
    // if (wT < pB && wB > pT) {
    if(true){
      loadFullImage(pItem[p]);
      pItem[p].classList.remove('replace');
    }
    else p++;

  }

}


// replace with full image
function loadFullImage(item) {

  if (!item || !item.href) return;

  // load image
  var img = new Image();
  if (item.dataset) {
    img.srcset = item.dataset.srcset || '';
    img.sizes = item.dataset.sizes || '';
  }
  img.src = item.href;
  img.className = 'reveal';
  if (img.complete) addImg();
  else img.onload = addImg;

  // replace image
  function addImg() {
  	// 調整圖片
		$(".not_yet").each(function() {
			autoAdjust($(this));
		});

    // disable click
    item.addEventListener('click', function(e) { e.preventDefault(); }, false);

    // add full image
    item.appendChild(img).addEventListener('animationend', function(e) {

      // remove preview image
      var pImg = item.querySelector && item.querySelector('img.preview');
      if (pImg) {
        e.target.alt = pImg.alt || '';
        item.removeChild(pImg);
        e.target.classList.remove('reveal');
      }


    });

  }

}